# TinyKV

ä¸€ä¸ªåŸºäº C++20 å®ç°çš„**åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿ**ï¼Œå®Œæ•´å®ç°äº† Raft ä¸€è‡´æ€§ç®—æ³•ã€åˆ†ç‰‡ç»„æœºåˆ¶å’ŒåŠ¨æ€æˆå‘˜å˜æ›´ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ åˆ†å¸ƒå¼ä¸€è‡´æ€§
- **Raft ç®—æ³•å®Œæ•´å®ç°**ï¼šé¢†å¯¼è€…é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å¿«ç…§æœºåˆ¶
- **å¼ºä¸€è‡´æ€§ä¿è¯**ï¼šæ‰€æœ‰å†™æ“ä½œé€šè¿‡ Raft ä¿è¯çº¿æ€§ä¸€è‡´æ€§
- **åŠ¨æ€æˆå‘˜å˜æ›´**ï¼šæ”¯æŒå®‰å…¨çš„èŠ‚ç‚¹æ·»åŠ /ç§»é™¤ï¼Œä½¿ç”¨é…ç½®æ—¥å¿—é¿å…è„‘è£‚

### ğŸ“Š åˆ†ç‰‡ä¸é«˜å¯ç”¨
- **åˆ†ç‰‡ç»„æœºåˆ¶**ï¼šæ¯ä¸ªåˆ†ç‰‡åŒ…å«å¤šä¸ªå‰¯æœ¬ï¼Œé€šè¿‡ Raft ä¿è¯ä¸€è‡´æ€§
- **æ°´å¹³æ‰©å±•**ï¼šæ”¯æŒæ•°æ®åˆ†ç‰‡ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†ç‰‡ç»„
- **é«˜å¯ç”¨è®¾è®¡**ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾ï¼Œä¿è¯æœåŠ¡å¯ç”¨æ€§

### ğŸš€ å·¥ç¨‹å®è·µ
- **æœåŠ¡å‘ç°**ï¼šåŸºäº Zookeeper çš„è‡ªåŠ¨æœåŠ¡æ³¨å†Œä¸å‘ç°
- **é«˜æ€§èƒ½ RPC**ï¼šåŸºäº Muduo ç½‘ç»œåº“å’Œ Protobuf çš„é«˜æ•ˆé€šä¿¡
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šåŸºäº RocksDB çš„å¯é æ•°æ®å­˜å‚¨
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ”¯æŒèŠ‚ç‚¹é‡å¯åçŠ¶æ€æ¢å¤
- **å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ**ï¼šåŒç¼“å†²é˜Ÿåˆ—å®ç°é«˜æ€§èƒ½æ—¥å¿—ï¼Œå‡å°‘å¯¹ä¸šåŠ¡çº¿ç¨‹å½±å“
- **äº‹ä»¶é©±åŠ¨å®šæ—¶å™¨**ï¼šé«˜æ•ˆå®šæ—¶æœºåˆ¶ï¼Œæ”¯æŒéšæœºè¶…æ—¶ï¼Œç”¨äºRafté€‰ä¸¾

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Layer                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ RPC (Protobuf)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              KVService Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Shard      â”‚  â”‚   Routing    â”‚  â”‚   Client     â”‚ â”‚
â”‚  â”‚  Manager     â”‚  â”‚   Logic      â”‚  â”‚   Forward    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            KVStateMachine (Raft State Machine)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Raft Consensus Layer                     â”‚  â”‚
â”‚  â”‚  â€¢ Leader Election  â€¢ Log Replication           â”‚  â”‚
â”‚  â”‚  â€¢ Snapshot        â€¢ Membership Change          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Storage Layer (RocksDB)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—

#### 1. Raft ä¸€è‡´æ€§å±‚ (`storage/raft/`)
- **é¢†å¯¼è€…é€‰ä¸¾**ï¼šéšæœºè¶…æ—¶æœºåˆ¶é¿å…é€‰ä¸¾å†²çª
- **æ—¥å¿—å¤åˆ¶**ï¼šAppendEntries RPC å®ç°æ—¥å¿—åŒæ­¥
- **å¿«ç…§æœºåˆ¶**ï¼šæ—¥å¿—å‹ç¼©å’Œå¿«ç…§å®‰è£…
- **æˆå‘˜å˜æ›´**ï¼šåŸºäºé…ç½®æ—¥å¿—çš„å®‰å…¨æˆå‘˜å˜æ›´ï¼ˆSingle Server Changesï¼‰

#### 2. åˆ†ç‰‡ç®¡ç† (`common/shard/`)
- **åˆ†ç‰‡ç»„ï¼ˆShardGroupï¼‰**ï¼šæ¯ä¸ªåˆ†ç‰‡åŒ…å«å¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹
- **è·¯ç”±æœºåˆ¶**ï¼šåŸºäº FNV-1a å“ˆå¸Œçš„ key åˆ°åˆ†ç‰‡æ˜ å°„
- **ä¸»èŠ‚ç‚¹è·¯ç”±**ï¼šè¯»å†™æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°åˆ†ç‰‡ç»„ä¸»èŠ‚ç‚¹
- **åŠ¨æ€é‡å¹³è¡¡**ï¼šèŠ‚ç‚¹å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°åˆ†é…åˆ†ç‰‡ç»„

#### 3. KV æœåŠ¡å±‚ (`kvserver/`, `kvservice/`)
- **æœåŠ¡å‘ç°é›†æˆ**ï¼šä¸ Zookeeper é›†æˆï¼Œè‡ªåŠ¨å‘ç°èŠ‚ç‚¹
- **é…ç½®å˜æ›´å¤„ç†**ï¼šç›‘å¬é…ç½®å˜æ›´ï¼Œè‡ªåŠ¨åˆ›å»º/æ›´æ–° RaftClient è¿æ¥
- **è¯·æ±‚è·¯ç”±**ï¼šè·¨åˆ†ç‰‡çš„è¯·æ±‚è‡ªåŠ¨è½¬å‘

#### 4. å­˜å‚¨å¼•æ“ (`common/storage/`)
- **RocksDB å°è£…**ï¼šæä¾› Put/Get/Delete/Append æ“ä½œ
- **å¿«ç…§æ”¯æŒ**ï¼šæ”¯æŒæ•°æ®å¿«ç…§å’Œæ¢å¤

#### 5. åŸºç¡€è®¾æ–½ (`common/`)
- **äº‹ä»¶é©±åŠ¨å®šæ—¶å™¨**ï¼šé«˜æ•ˆå®šæ—¶æœºåˆ¶ï¼Œæ”¯æŒéšæœºè¶…æ—¶
- **å¼‚æ­¥åŒç¼“å†²æ—¥å¿—**ï¼šé«˜æ€§èƒ½å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ
- **çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—**ï¼šLockQueue å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
- **é…ç½®ç®¡ç†**ï¼šåŸºäº TOML çš„é…ç½®ç³»ç»Ÿ

## ğŸ”‘ å…³é”®æŠ€æœ¯å®ç°

### 1. äº‹ä»¶é©±åŠ¨å®šæ—¶å™¨

**è®¾è®¡ç›®æ ‡**ï¼šä¸º Raft é€‰ä¸¾å’Œå¿ƒè·³æä¾›é«˜æ•ˆçš„å®šæ—¶æœºåˆ¶ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨æ¡ä»¶å˜é‡å®ç°é«˜æ•ˆç­‰å¾…ï¼Œé¿å…å¿™ç­‰
- **éšæœºæ¨¡å¼**ï¼šæ”¯æŒéšæœºè¶…æ—¶ï¼Œé¿å…é€‰ä¸¾å†²çª
- **åŠ¨æ€é‡ç½®**ï¼šæ”¯æŒè¿è¡Œæ—¶é‡ç½®å®šæ—¶å™¨ï¼Œç”¨äº Raft é€‰ä¸¾è¶…æ—¶é‡ç½®

```cpp
// æ™®é€šæ¨¡å¼ï¼šå›ºå®šå‘¨æœŸ
timer->start(100, true, callback, Timer::Mode::Normal);

// éšæœºæ¨¡å¼ï¼šéšæœºè¶…æ—¶ï¼ˆç”¨äºRafté€‰ä¸¾ï¼‰
timer->set_random(400, 800);
timer->start(0, true, callback, Timer::Mode::Random);
```

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `std::condition_variable::wait_until` å®ç°ç²¾ç¡®ç­‰å¾…
- æ”¯æŒåŠ¨æ€é‡ç½®ï¼Œä¸é˜»å¡è°ƒç”¨çº¿ç¨‹
- çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒå¹¶å‘è°ƒç”¨

### 2. å¼‚æ­¥åŒç¼“å†²é˜Ÿåˆ—æ—¥å¿—ç³»ç»Ÿ

**è®¾è®¡ç›®æ ‡**ï¼šé«˜æ€§èƒ½å¼‚æ­¥æ—¥å¿—ï¼Œå‡å°‘å†™æ—¥å¿—å¯¹ä¸šåŠ¡çº¿ç¨‹çš„å½±å“ã€‚

**åŒç¼“å†²æœºåˆ¶**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡çº¿ç¨‹å†™   â”‚â”€â”€â”€â–º â”‚ å‰å° buffer â”‚      â”‚ åå° buffer â”‚â—„â”€â”€â”
â”‚ (lock-free) â”‚     â”‚ (å¤šå†™è€…)     â”‚â—„â”€â”€â”€â–ºâ”‚ (å•çº¿ç¨‹)    â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                           â–²                                â”‚
                           â”‚ swap (æ‰¹é‡)                    â”‚
                           â–¼                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚ åå°çº¿ç¨‹     â”‚â”€â”€â”€â–º â”‚ ç£ç›˜æ–‡ä»¶     â”‚   â”‚
                    â”‚ (æ‰¹é‡åˆ·ç›˜)   â”‚     â”‚ (æŒ‰æ—¥æœŸåˆ‡åˆ†) â”‚   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **å‡å°‘é”ç«äº‰**ï¼šå‰å°å†™å…¥å‡ ä¹æ— é”ï¼ˆæ‰¹é‡swapæ—¶æ‰åŠ é”ï¼‰
- **æ‰¹é‡åˆ·ç›˜**ï¼šåå°çº¿ç¨‹æ‰¹é‡å†™å…¥ï¼Œæé«˜IOæ•ˆç‡
- **å¼‚æ­¥éé˜»å¡**ï¼šä¸šåŠ¡çº¿ç¨‹å†™å…¥åç«‹å³è¿”å›ï¼Œä¸é˜»å¡

**å®ç°ç»†èŠ‚**ï¼š
```cpp
// å‰å°å†™å…¥ï¼šå¿«é€Ÿappendï¼Œæ‰¹é‡æ—¶swap
void append(U&& msg) {
    _front->emplace_back(std::forward<U>(msg));
    if (_front->size() >= kBatchSize) {
        _front.swap(_back);  // å¿«é€Ÿswapï¼Œå‡ ä¹æ— é”
        _cond.notify_one();  // å”¤é†’åå°çº¿ç¨‹
    }
}

// åå°åˆ·ç›˜ï¼šæ‰¹é‡å†™å…¥æ–‡ä»¶
auto batch = _queue.pop();  // è·å–æ•´æ‰¹æ•°æ®
for (const auto& entry : batch) {
    out << format_entry(entry);
}
```

### 3. Raft æˆå‘˜å˜æ›´

**é—®é¢˜**ï¼šç›´æ¥æ›¿æ¢ peers åˆ—è¡¨ä¼šå¯¼è‡´è„‘è£‚å’Œä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨é…ç½®æ—¥å¿—æ¡ç›®ï¼ˆConfiguration Log Entryï¼‰å®ç°å®‰å…¨çš„æˆå‘˜å˜æ›´ã€‚

```cpp
// é€šè¿‡æ—¥å¿—æè®®é…ç½®å˜æ›´
std::tuple<uint32_t, uint64_t, bool> ProposeConfigChange(
    const ::command::ConfigChangeCommand& config_change);

// é…ç½®å˜æ›´è¢«åº”ç”¨åï¼Œè‡ªåŠ¨æ›´æ–°è¿æ¥
void handleConfigChange(const ::command::ConfigChangeCommand& config_change);
```

**ç‰¹ç‚¹**ï¼š
- Single Server Changesï¼šä¸€æ¬¡åªå˜æ›´ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé¿å…è„‘è£‚
- é…ç½®æ—¥å¿—ï¼šé€šè¿‡ Raft æ—¥å¿—ä¿è¯é…ç½®å˜æ›´çš„ä¸€è‡´æ€§
- è‡ªåŠ¨å¤„ç†ï¼šKVServer è‡ªåŠ¨åˆ›å»º/æ›´æ–° RaftClient è¿æ¥

### 3. åˆ†ç‰‡ç»„æœºåˆ¶

**è®¾è®¡æ€è·¯**ï¼šæ¯ä¸ªåˆ†ç‰‡åˆ›å»ºåˆ†ç‰‡ç»„ï¼ŒåŒ…å«å¤šä¸ªå‰¯æœ¬ï¼Œé€šè¿‡ Raft ä¿è¯ä¸€è‡´æ€§ã€‚

```cpp
struct ShardGroup {
    uint32_t shard_id;
    std::vector<std::string> nodes;  // å‰¯æœ¬èŠ‚ç‚¹åˆ—è¡¨
    std::string leader;              // å½“å‰ä¸»èŠ‚ç‚¹
};
```

**å·¥ä½œæµç¨‹**ï¼š
1. Key â†’ å“ˆå¸Œ â†’ åˆ†ç‰‡ID
2. åˆ†ç‰‡ID â†’ åˆ†ç‰‡ç»„ â†’ ä¸»èŠ‚ç‚¹
3. è¯·æ±‚è·¯ç”±åˆ°ä¸»èŠ‚ç‚¹å¤„ç†
4. ä¸»èŠ‚ç‚¹é€šè¿‡ Raft å¤åˆ¶åˆ°å‰¯æœ¬

**ä¼˜åŠ¿**ï¼š
- æ°´å¹³æ‰©å±•ï¼šæ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹
- é«˜å¯ç”¨ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾
- å¼ºä¸€è‡´æ€§ï¼šåˆ†ç‰‡ç»„å†…é€šè¿‡ Raft ä¿è¯

### 4. è¯·æ±‚è·¯ç”±

**æœ¬åœ°ä¼˜å…ˆç­–ç•¥**ï¼š
- æ£€æŸ¥ key æ˜¯å¦å±äºå½“å‰èŠ‚ç‚¹ï¼ˆæ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹ï¼‰
- æœ¬åœ°å¤„ç†ï¼šç›´æ¥æäº¤åˆ° Raft
- è¿œç¨‹è½¬å‘ï¼šé€šè¿‡ KVClient è½¬å‘åˆ°ä¸»èŠ‚ç‚¹

```cpp
if (_shard_manager->IsShardLeader(shard_id, _name)) {
    // æœ¬åœ°å¤„ç†
    _sm->submit(command);
} else {
    // è½¬å‘åˆ°ä¸»èŠ‚ç‚¹
    auto client = GetOrCreateClient(leader);
    client->Get(request);
}
```

## ğŸ“‹ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” | ç‰ˆæœ¬ |
|------|------|------|
| **C++20** | æ ¸å¿ƒè¯­è¨€ | - |
| **Raft** | ä¸€è‡´æ€§ç®—æ³• | è‡ªå®ç° |
| **RocksDB** | å­˜å‚¨å¼•æ“ | v10.5.1 |
| **Muduo** | ç½‘ç»œåº“ | - |
| **Protobuf** | åºåˆ—åŒ–/RPC | - |
| **Zookeeper** | æœåŠ¡å‘ç° | - |
| **xmake** | æ„å»ºå·¥å…· | 2.8.0+ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£… xmake
curl -fsSL https://xmake.io/shget.text | bash

# å®‰è£… Zookeeper (Ubuntu/Debian)
sudo apt-get install libzookeeper-mt-dev
```

### 2. é…ç½®

ç¼–è¾‘ `default_config.toml`ï¼š

```toml
[zookeeper]
host = "127.0.0.1"
port = 2181

[rpc_server]
host = "127.0.0.1"
port = "8000"

[sharding]
num_shards = 10        # åˆ†ç‰‡æ•°é‡
replica_count = 3      # æ¯ä¸ªåˆ†ç‰‡çš„å‰¯æœ¬æ•°
```

### 3. æ„å»ºä¸è¿è¡Œ

```bash
# æ„å»º
xmake -m release

# å¯åŠ¨æœåŠ¡ï¼ˆéœ€è¦å…ˆå¯åŠ¨ Zookeeperï¼‰
./bin/kvserver
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
TinyKV/
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ storage/raft/      # Raft ç®—æ³•å®ç°
â”‚   â”œâ”€â”€ kvserver/          # KV æœåŠ¡å™¨ï¼ˆæœåŠ¡å‘ç°ã€è¿æ¥ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ kvservice/         # KV æœåŠ¡å±‚ï¼ˆè·¯ç”±ã€è½¬å‘ï¼‰
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ shard/         # åˆ†ç‰‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ storage/       # RocksDB å°è£…
â”‚   â”‚   â”œâ”€â”€ rpc/           # RPC æ¡†æ¶
â”‚   â”‚   â””â”€â”€ ...            # å·¥å…·æ¨¡å—
â”‚   â””â”€â”€ discovery/         # Zookeeper å®¢æˆ·ç«¯
â”œâ”€â”€ src/                    # æºæ–‡ä»¶
â”œâ”€â”€ tests/                  # å•å…ƒæµ‹è¯•
â””â”€â”€ xmake.lua              # æ„å»ºé…ç½®
```

## ğŸ’¡ é¡¹ç›®äº®ç‚¹

### 1. å®Œæ•´çš„ Raft å®ç°
- âœ… é¢†å¯¼è€…é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å¿«ç…§æœºåˆ¶
- âœ… å®‰å…¨çš„æˆå‘˜å˜æ›´ï¼ˆé…ç½®æ—¥å¿—ï¼‰
- âœ… çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤

### 2. åˆ†ç‰‡ç»„è®¾è®¡
- âœ… æ”¯æŒæ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨
- âœ… è‡ªåŠ¨è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
- âœ… åŠ¨æ€é‡å¹³è¡¡

### 3. é«˜æ€§èƒ½åŸºç¡€è®¾æ–½
- âœ… **äº‹ä»¶é©±åŠ¨å®šæ—¶å™¨**ï¼šé«˜æ•ˆç­‰å¾…ï¼Œæ”¯æŒéšæœºè¶…æ—¶
- âœ… **å¼‚æ­¥åŒç¼“å†²æ—¥å¿—**ï¼šå‡å°‘é”ç«äº‰ï¼Œæ‰¹é‡åˆ·ç›˜
- âœ… **å¼‚æ­¥ RPC é€šä¿¡**ï¼šåŸºäº Muduo çš„é«˜æ€§èƒ½ç½‘ç»œåº“

### 4. å·¥ç¨‹å®è·µ
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£æ¸…æ™°
- âœ… å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤
- âœ… å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- âœ… å•ä¾‹æ¨¡å¼ã€RAII ç­‰ C++ æœ€ä½³å®è·µ

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
xmake build test_raft
./bin/test_raft

xmake build test_persister
./bin/test_persister
```

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### å®šæ—¶å™¨å®ç°
- **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨ `std::condition_variable::wait_until` å®ç°ç²¾ç¡®ç­‰å¾…
- **éšæœºè¶…æ—¶**ï¼šRaft é€‰ä¸¾ä½¿ç”¨éšæœºè¶…æ—¶ï¼ˆ400-800msï¼‰ï¼Œé¿å…é€‰ä¸¾å†²çª
- **åŠ¨æ€é‡ç½®**ï¼šæ”¯æŒè¿è¡Œæ—¶é‡ç½®ï¼Œç”¨äºé€‰ä¸¾è¶…æ—¶é‡ç½®

### æ—¥å¿—ç³»ç»Ÿå®ç°
- **åŒç¼“å†²é˜Ÿåˆ—**ï¼šå‰å°ç¼“å†²åŒºï¼ˆå¤šå†™è€…ï¼‰å’Œåå°ç¼“å†²åŒºï¼ˆå•çº¿ç¨‹åˆ·ç›˜ï¼‰
- **æ‰¹é‡åˆ·ç›˜**ï¼šè¾¾åˆ°é˜ˆå€¼ï¼ˆ4KBï¼‰æ—¶æ‰¹é‡swapï¼Œå‡å°‘IOæ¬¡æ•°
- **æŒ‰æ—¥æœŸåˆ‡åˆ†**ï¼šæ—¥å¿—æ–‡ä»¶æŒ‰æ—¥æœŸè‡ªåŠ¨åˆ‡åˆ†ï¼Œä¾¿äºç®¡ç†
- **å¼‚æ­¥éé˜»å¡**ï¼šä¸šåŠ¡çº¿ç¨‹å†™å…¥åç«‹å³è¿”å›ï¼Œä¸é˜»å¡

### æ€§èƒ½ä¼˜åŒ–
- **å‡å°‘é”ç«äº‰**ï¼šåŒç¼“å†²é˜Ÿåˆ—åªåœ¨swapæ—¶åŠ é”ï¼Œå†™å…¥å‡ ä¹æ— é”
- **æ‰¹é‡æ“ä½œ**ï¼šæ—¥å¿—æ‰¹é‡åˆ·ç›˜ï¼ŒRPCæ‰¹é‡å¤„ç†
- **è¿æ¥å¤ç”¨**ï¼šRaftClientè¿æ¥æ± ï¼Œå‡å°‘è¿æ¥å¼€é”€

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ™ è‡´è°¢

- [Raft è®ºæ–‡](https://raft.github.io/)
- [Muduo ç½‘ç»œåº“](https://github.com/chenshuo/muduo)
- [RocksDB](https://github.com/facebook/rocksdb)
